<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../../">
  <title data-ice="title">WTF-Adventure/src/server/js/game/world.js | WTF Adventure</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="documentation for your wtf needs"><meta property="og:type" content="website"><meta property="og:url" content="http://design1online.com"><meta property="og:site_name" content="WTF Adventure"><meta property="og:title" content="WTF Adventure"><meta property="og:image" content="http://design1online.com/logo.png"><meta property="og:description" content="documentation for your wtf needs"><meta property="og:author" content="https://design1online.com"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="WTF Adventure"><meta property="twitter:description" content="documentation for your wtf needs"><meta property="twitter:image" content="http://design1online.com/logo.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/design1online/WTF-Adventure"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js">src/client/js</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/app.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/game.js~Game.html">Game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/main.js~WTF.html">WTF</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-controllers">src/client/js/controllers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/audio.js~Audio.html">Audio</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/bubble.js~Bubble.html">Bubble</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/chat.js~Chat.html">Chat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/entities.js~Entities.html">Entities</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/info.js~Info.html">Info</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/input.js~Input.html">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/interface.js~Interface.html">Interface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/overlay.js~Overlay.html">Overlay</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/pickcharacter.js~PickCharacter.html">PickCharacter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/pointer.js~Cursor.html">Cursor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/sprites.js~Sprites.html">Sprites</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/controllers/zoning.js~Zone.html">Zone</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-entity">src/client/js/entity</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/animation.js~Animation.html">Animation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/entity.js~Entity.html">Entity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/entityhandler.js~EntityHandler.html">EntityHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/sprite.js~Sprite.html">Sprite</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-entity-character">src/client/js/entity/character</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/character.js~Character.html">Character</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-entity-character-mob">src/client/js/entity/character/mob</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/mob/mob.js~Mob.html">Mob</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-entity-character-npc">src/client/js/entity/character/npc</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/npc/npc.js~Npc.html">Npc</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-entity-character-player">src/client/js/entity/character/player</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/player.js~Player.html">Player</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/playerhandler.js~PlayerHandler.html">PlayerHandler</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-entity-character-player-equipment">src/client/js/entity/character/player/equipment</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/equipment/armour.js~Armour.html">Armour</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/equipment/boots.js~Boots.html">Boots</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/equipment/equipment.js~Equipment.html">Equipment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/equipment/pendant.js~Pendant.html">Pendant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/equipment/ring.js~Ring.html">Ring</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/character/player/equipment/weapon.js~Weapon.html">Weapon</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-entity-objects">src/client/js/entity/objects</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/objects/chest.js~Chest.html">Chest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/objects/item.js~Item.html">Item</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/entity/objects/projectile.js~Projectile.html">Projectile</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-interface">src/client/js/interface</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/abilities.js~Abilities.html">Abilities</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/actions.js~Actions.html">Actions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/bank.js~Bank.html">Bank</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/enchant.js~Enchant.html">Enchant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/inventory.js~Inventory.html">Inventory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/warp.js~Warp.html">Warp</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-interface-container">src/client/js/interface/container</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/container/container.js~Container.html">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/container/slot.js~Slot.html">Slot</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-interface-profile">src/client/js/interface/profile</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/profile/page.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/profile/profile.js~Profile.html">Profile</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-interface-profile-pages">src/client/js/interface/profile/pages</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/profile/pages/ability.js~Ability.html">Ability</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/profile/pages/quest.js~Quest.html">Quest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/profile/pages/settings.js~Settings.html">Settings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/interface/profile/pages/state.js~State.html">State</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-lib">src/client/js/lib</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/lib/log.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-astar">astar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logger">logger</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-map">src/client/js/map</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/map/map.js~Map.html">Map</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-network">src/client/js/network</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/network/messages.js~Messages.html">Messages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/network/socket.js~Socket.html">Socket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Packets">Packets</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-renderer">src/client/js/renderer</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/camera.js~Camera.html">Camera</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/grids.js~Grids.html">Grids</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/renderer.js~Renderer.html">Renderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/tile.js~Tile.html">Tile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/updater.js~Updater.html">Updater</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-renderer-bubbles">src/client/js/renderer/bubbles</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/bubbles/blob.js~Blob.html">Blob</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-renderer-infos">src/client/js/renderer/infos</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/infos/splat.js~Splat.html">Splat</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-renderer-pointers">src/client/js/renderer/pointers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/renderer/pointers/pointer.js~Pointer.html">Pointer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-client-js-utils">src/client/js/utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/utils/pathfinder.js~Pathfinder.html">Pathfinder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/utils/queue.js~Queue.html">Queue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/utils/storage.js~Storage.html">Storage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/utils/timer.js~Timer.html">Timer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/client/js/utils/transition.js~Transition.html">Transition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isInt">isInt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isIntersecting">isIntersecting</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TRANSITIONEND">TRANSITIONEND</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-data-combat">src/server/data/combat</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/data/combat/greatsquid.js~GreatSquid.html">GreatSquid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/data/combat/ogrelord.js~OgreLord.html">OgreLord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/data/combat/piratecaptain.js~PirateCaptain.html">PirateCaptain</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/data/combat/queenant.js~QueenAnt.html">QueenAnt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/data/combat/skeletonking.js~SkeletonKing.html">SkeletonKing</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/data/combat/tenebris.js~Tenebris.html">Tenebris</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-data-items">src/server/data/items</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/data/items/healthFlask.js~Flask.html">Flask</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-controllers">src/server/js/controllers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/controllers/commands.js~Commands.html">Commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/controllers/incoming.js~Incoming.html">Incoming</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/controllers/minigames.js~Minigames.html">Minigames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/controllers/quests.js~Quests.html">Quests</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/controllers/shops.js~Shops.html">Shops</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-database">src/server/js/database</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/database/creator.js~Creator.html">Creator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/database/loader.js~Loader.html">Loader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/database/mysql.js~MySQL.html">MySQL</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game">src/server/js/game</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/world.js~World.html">World</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity">src/server/js/game/entity</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/entity.js~Entity.html">Entity</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character">src/server/js/game/entity/character</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/character.js~Character.html">Character</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-combat">src/server/js/game/entity/character/combat</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/combat/combat.js~Combat.html">Combat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/combat/combatqueue.js~CombatQueue.html">CombatQueue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/combat/hit.js~Hit.html">Hit</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-mob">src/server/js/game/entity/character/mob</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/mob/mob.js~Mob.html">Mob</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player">src/server/js/game/entity/character/player</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/achievement.js~Achievement.html">Achievement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/checkpoint.js~Checkpoint.html">Checkpoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/guild.js~Guild.html">Guild</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/handler.js~Handler.html">Handler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/player.js~Player.html">Player</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/trade.js~Trade.html">Trade</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/warp.js~Warp.html">Warp</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-ability">src/server/js/game/entity/character/player/ability</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/ability/abilities.js~Abilities.html">Abilities</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-ability-misc">src/server/js/game/entity/character/player/ability/misc</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/ability/misc/ability.js~Ability.html">Ability</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/ability/misc/firestrike.js~FireStrike.html">FireStrike</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/ability/misc/iceattack.js~IceAttack.html">IceAttack</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/ability/misc/run.js~Run.html">Run</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-containers">src/server/js/game/entity/character/player/containers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/containers/container.js~Container.html">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/containers/slot.js~Slot.html">Slot</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-containers-bank">src/server/js/game/entity/character/player/containers/bank</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/containers/bank/bank.js~Slot.html">Slot</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-containers-inventory">src/server/js/game/entity/character/player/containers/inventory</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/containers/inventory/inventory.js~Inventory.html">Inventory</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-enchant">src/server/js/game/entity/character/player/enchant</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/enchant/enchant.js~Enchant.html">Enchant</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-equipment">src/server/js/game/entity/character/player/equipment</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/equipment/armour.js~Armour.html">Armour</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/equipment/boots.js~Boots.html">Boots</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/equipment/equipment.js~Equipment.html">Equipment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/equipment/pendant.js~Pendant.html">Pendant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/equipment/ring.js~Ring.html">Ring</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/equipment/weapon.js~Weapon.html">Weapon</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-points">src/server/js/game/entity/character/player/points</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/points/hitpoints.js~HitPoints.html">HitPoints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/points/mana.js~Mana.html">Mana</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/points/points.js~Points.html">Points</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-profession">src/server/js/game/entity/character/player/profession</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/profession/profession.js~Profession.html">Profession</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-profession-impl">src/server/js/game/entity/character/player/profession/impl</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/profession/impl/foresting.js~Foresting.html">Foresting</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-quest">src/server/js/game/entity/character/player/quest</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/quest/quest.js~Quest.html">Quest</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-character-player-quest-misc">src/server/js/game/entity/character/player/quest/misc</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/quest/misc/bulkysituation.js~BulkySituation.html">BulkySituation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/quest/misc/introduction.js~Introduction.html">Introduction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/character/player/quest/misc/thelie.js~TheLie.html">TheLie</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-npc">src/server/js/game/entity/npc</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/npc/npc.js~NPC.html">NPC</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-game-entity-objects">src/server/js/game/entity/objects</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/objects/chest.js~Chest.html">Chest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/objects/item.js~Item.html">Item</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/game/entity/objects/projectile.js~Projectile.html">Projectile</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-map">src/server/js/map</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/map/area.js~Area.html">Area</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/map/grids.js~Grids.html">Grids</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/map/groups.js~Groups.html">Groups</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/map/map.js~Map.html">Map</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-map-areas">src/server/js/map/areas</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/map/areas/chestareas.js~ChestAreas.html">ChestAreas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/map/areas/musicareas.js~MusicAreas.html">MusicAreas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/map/areas/pvpareas.js~PVPAreas.html">PVPAreas</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-minigames">src/server/js/minigames</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/minigames/minigame.js~Minigame.html">Minigame</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-minigames-impl">src/server/js/minigames/impl</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/minigames/impl/teamwar.js~TeamWar.html">TeamWar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-network">src/server/js/network</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/network/socket.js~Socket.html">Socket</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-server-js-util">src/server/js/util</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/server/js/util/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-requireItems">requireItems</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AbilityDictionary">AbilityDictionary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ItemsDictionary">ItemsDictionary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MobsDictionary">MobsDictionary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NpcsDictionary">NpcsDictionary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ShopsDictionary">ShopsDictionary</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-tools-api">src/tools/api</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/tools/api/registrar.js~Registrar.html">Registrar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-tools-bot">src/tools/bot</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/WTF-Adventure/src/tools/bot/bot.js~Bot.html">Bot</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src-tools-map">src/tools/map</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parse">parse</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">WTF-Adventure/src/server/js/game/world.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import _ from &apos;underscore&apos;;
import log from &apos;../util/log&apos;;
import config from &apos;../../config.json&apos;;
import Player from &apos;./entity/character/player/player&apos;;
import Map from &apos;../map/map&apos;;
import Messages from &apos;../network/messages&apos;;
import Utils from &apos;../util/utils&apos;;
import MobsDictionary from &apos;../util/mobs&apos;;
import Mob from &apos;./entity/character/mob/mob&apos;;
import NpcsDictionary from &apos;../util/npcs&apos;;
import NPC from &apos;./entity/npc/npc&apos;;
import ItemsDictionary from &apos;../util/items&apos;;
import Item from &apos;./entity/objects/item&apos;;
import Chest from &apos;./entity/objects/chest&apos;;
import Character from &apos;./entity/character/character&apos;;
import Projectile from &apos;./entity/objects/projectile&apos;;
import Packets from &apos;../network/packets&apos;;
import Formulas from &apos;./formulas&apos;;
import Modules from &apos;../util/modules&apos;;

export default class World {
  constructor(id, socket, database) {
    this.id = id;
    this.socket = socket;
    this.database = database;
    this.playerCount = 0;
    this.maxPlayers = config.maxPlayers;
    this.updateTime = config.updateTime;
    this.debug = false;

    this.players = {};
    this.entities = {};
    this.chests = {};
    this.itemsDictionary = ItemsDictionary;
    this.mobsDictionary = MobsDictionary;
    this.npcsDictionary = NpcsDictionary;
    this.projectiles = {};
    this.packets = {};
    this.groups = {};

    this.loadedGroups = false;
    this.ready = false;
    this.malformTimeout = null;

    this.onPlayerConnection((connection) =&gt; {
      if (config.development) {
        connection.sendUTF8(&apos;maintenance&apos;);
        connection.close();

        return;
      }

      const clientId = Utils.generateClientId();
      const player = new Player(this, this.database, connection, clientId);
      const diff = new Date().getTime()
        - this.socket.ips[connection.socket.conn.remoteAddress];

      if (diff &lt; 4000) {
        connection.sendUTF8(&apos;toofast&apos;);
        connection.close(&apos;Logging in too rapidly&apos;);

        return;
      }

      this.socket.ips[
        connection.socket.conn.remoteAddress
      ] = new Date().getTime();

      this.addToPackets(player);

      this.pushToPlayer(
        player,
        new Messages.Handshake(clientId, config.devClient),
      );
    });

    /**
     * Grab the exact number of players from
     * the array of packets instead of adding
     * and subtracting and risking uncertainties.
     */
    this.onPopulationChange(() =&gt; {
      this.pushBroadcast(new Messages.Population(this.getPopulation()));
    });
  }

  /**
   * The reason maps are loaded per each world is because
   * we can have slight modifications for each world if we want in the
   * future. Using region loading, we can just send the client
   * whatever new map we have created server sided. Cleaner and nicer.
   */
  load(onWorldLoad) {
    log.info(`************ World ${this.id} ***********`);

    this.map = new Map(this);
    this.map.isReady(() =&gt; {
      this.loadGroups();
      this.spawnChests();
      this.spawnEntities();

      log.info(&apos;The map has been successfully loaded!&apos;);

      this.loaded();
      onWorldLoad();
    });
  }

  /**
   * Similar to TTA engine here, but it&apos;s loaded upon initialization
   * rather than being called from elsewhere.
   */
  loaded() {
    this.tick();

    if (!config.offlineMode) {
      this.dataParser();
    }

    this.ready = true;
    log.info(&apos;********************************&apos;);
  }

  tick() {
    setInterval(() =&gt; {
      this.parsePackets();
      this.parseGroups();
    }, 1000 / this.updateTime);
  }

  dataParser() {
    setInterval(() =&gt; {
      this.saveAll();
    }, 30000);
  }

  parsePackets() {
    /**
     * This parses through the packet pool and sends them
     */

    for (const id in this.packets) {
      if (this.packets[id].length &gt; 0 &amp;&amp; this.packets.hasOwnProperty(id)) {
        const conn = this.socket.getConnection(id);

        if (conn) {
          conn.send(this.packets[id]);
          this.packets[id] = [];
          this.packets[id].id = id;
        } else {
          delete this.socket.getConnection(id);
        }
      }
    }
  }

  parseGroups() {
    if (!this.loadedGroups) {
      return;
    }

    this.map.groups.forEachGroup((groupId) =&gt; {
      if (this.groups[groupId].incoming.length &lt; 1) {
        return;
      }

      this.sendSpawns(groupId);

      this.groups[groupId].incoming = [];
    });
  }

  /**
   * Entity related functions
   */

  kill(entity) {
    entity.applyDamage(entity.hitPoints);

    this.pushToAdjacentGroups(
      entity.group,
      new Messages.Points(entity.instance, entity.getHitPoints(), null),
    );
    this.pushToAdjacentGroups(
      entity.group,
      new Messages.Despawn(entity.instance),
    );

    this.handleDeath(entity, true);
  }

  handleDamage(attacker, target, damage) {
    if (!attacker || !target || isNaN(damage) || target.invincible) {
      return;
    }

    if (target.type === &apos;player&apos; &amp;&amp; target.hitCallback) {
      target.hitCallback(attacker, damage);
    }

    // Stop screwing with this - it&apos;s so the target retaliates.
    target.hit(attacker);
    target.applyDamage(damage);

    this.pushToAdjacentGroups(
      target.group,
      new Messages.Points(target.instance, target.getHitPoints(), null),
    );

    if (target.getHitPoints() &lt; 1) {
      target.combat.forEachAttacker((opponent) =&gt; {
        opponent.removeTarget();

        this.pushToAdjacentGroups(
          target.group,
          new Messages.Combat(Packets.CombatOpcode.Finish, [
            opponent.instance,
            target.instance,
          ]),
        );

        if (opponent.type === &apos;player&apos; || target.type === &apos;player&apos;) {
          if (opponent.type === &apos;mob&apos;) {
            opponent.addExperience(MobsDictionary.getXp(target.id));
          }

          if (opponent.type === &apos;player&apos;) {
            opponent.killCharacter(target);
          }
        }
      });

      this.pushToAdjacentGroups(
        target.group,
        new Messages.Despawn(target.instance),
      );
      this.handleDeath(target);
    }
  }

  handleDeath(character, ignoreDrops) {
    if (!character) {
      return;
    }

    if (character.type === &apos;mob&apos;) {
      const deathX = character.x;
      const deathY = character.y;

      if (character.deathCallback) {
        character.deathCallback();
      }

      this.removeEntity(character);

      character.dead = true; // eslint-disable-line
      character.destroy();
      character.combat.stop();

      if (!ignoreDrops) {
        const drop = character.getDrop();

        if (drop) this.dropItem(drop.id, drop.count, deathX, deathY);
      }
    } else if (character.type === &apos;player&apos;) character.die();
  }

  createProjectile(info) {
    const attacker = info.shift();
    const target = info.shift();

    if (!attacker || !target) {
      return null;
    }

    const startX = attacker.x;
    const startY = attacker.y;
    const type = attacker.getProjectile();
    let hit = null;

    const projectile = new Projectile(
      type,
      Utils.generateInstance(5, type, startX + startY),
    );

    projectile.setStart(startX, startY);
    projectile.setTarget(target);

    if (attacker.type === &apos;player&apos;) {
      hit = attacker.getHit(target);
    }

    projectile.damage = hit
      ? hit.damage
      : Formulas.getDamage(attacker, target, true);

    projectile.hitType = hit
      ? hit.type
      : Modules.Hits.Damage;

    projectile.owner = attacker;

    this.addProjectile(projectile);

    return projectile;
  }

  /**
   *
   * @param {int} groupId
   */
  sendSpawns(groupId) {
    if (!groupId) {
      return;
    }

    _.each(this.groups[groupId].incoming, (entity) =&gt; {
      if (entity.instance === null) {
        return;
      }

      this.pushToGroup(
        groupId,
        new Messages.Spawn(entity),
        entity.isPlayer() ? entity.instance : null,
      );
    });
  }

  loadGroups() {
    this.map.groups.forEachGroup((groupId) =&gt; {
      this.groups[groupId] = {
        entities: {},
        players: [],
        incoming: [],
      };
    });

    this.loadedGroups = true;
  }

  getEntityByInstance(instance) {
    if (instance in this.entities) {
      return this.entities[instance];
    }

    return null;
  }

  /**
   * Important functions for sending
   * messages to the player(s)
   */

  pushBroadcast(message) {
    _.each(this.packets, (packet) =&gt; {
      packet.push(message.serialize());
    });
  }

  pushSelectively(message, ignores) {
    _.each(this.packets, (packet) =&gt; {
      if (ignores.indexOf(packet.id) &lt; 0) {
        packet.push(message.serialize());
      }
    });
  }

  pushToPlayer(player, message) {
    if (player &amp;&amp; player.instance in this.packets) {
      this.packets[player.instance].push(message.serialize());
    }
  }

  pushToGroup(id, message, ignoreId) {
    const
      group = this.groups[id];

    if (!group) return;

    _.each(group.players, (playerId) =&gt; {
      if (playerId !== ignoreId) {
        this.pushToPlayer(this.getEntityByInstance(playerId), message);
      }
    });
  }

  pushToAdjacentGroups(groupId, message, ignoreId) {
    this.map.groups.forEachAdjacentGroup(groupId, (id) =&gt; {
      this.pushToGroup(id, message, ignoreId);
    });
  }

  pushToOldGroups(player, message) {
    _.each(player.recentGroups, (id) =&gt; {
      this.pushToGroup(id, message);
    });

    player.recentGroups = []; // eslint-disable-line
  }

  addToGroup(entity, groupId) {
    const
      newGroups = [];

    if (entity &amp;&amp; groupId &amp;&amp; groupId in this.groups) {
      this.map.groups.forEachAdjacentGroup(groupId, (id) =&gt; {
        const group = this.groups[id];

        if (group &amp;&amp; group.entities) {
          group.entities[entity.instance] = entity;
          newGroups.push(id);
        }
      });

      entity.group = groupId; // eslint-disable-line

      if (entity instanceof Player) {
        this.groups[groupId].players.push(entity.instance);
      }
    }

    return newGroups;
  }

  removeFromGroups(entity) {
    const oldGroups = [];

    if (entity &amp;&amp; entity.group) {
      const group = this.groups[entity.group];

      if (entity instanceof Player) {
        group.players = _.reject(group.players, id =&gt; id === entity.instance);
      }

      this.map.groups.forEachAdjacentGroup(entity.group, (id) =&gt; {
        if (this.groups[id] &amp;&amp; entity.instance in this.groups[id].entities) {
          delete this.groups[id].entities[entity.instance];
          oldGroups.push(id);
        }
      });

      entity.group = null; // eslint-disable-line
    }

    return oldGroups;
  }

  incomingToGroup(entity, groupId) {
    if (!entity || !groupId) {
      return;
    }

    this.map.groups.forEachAdjacentGroup(groupId, (id) =&gt; {
      const group = this.groups[id];

      if (group &amp;&amp; !_.include(group.entities, entity.instance)) {
        group.incoming.push(entity);
      }
    });
  }

  handleEntityGroup(entity) {
    let groupsChanged = false;

    if (!entity) {
      return groupsChanged;
    }

    const groupId = this.map.groups.groupIdFromPosition(entity.x, entity.y);

    if (!entity.group || (entity.group &amp;&amp; entity.group !== groupId)) {
      groupsChanged = true;

      this.incomingToGroup(entity, groupId);

      const oldGroups = this.removeFromGroups(entity);
      const newGroups = this.addToGroup(entity, groupId);

      if (_.size(oldGroups) &gt; 0) {
        entity.recentGroups = _.difference(oldGroups, newGroups); // eslint-disable-line
      }
    }

    return groupsChanged;
  }

  spawnEntities() {
    let entities = 0;

    _.each(this.map.staticEntities, (key, tileIndex) =&gt; {
      const isMob = !!this.mobsDictionary.getData(key);
      const isNpc = !!this.npcsDictionary.getData(key);
      const isItem = !!this.itemsDictionary.getData(key);

      const itemData = isItem
        ? this.itemsDictionary.getData(key)
        : null;

      const npcData = isNpc
        ? this.npcsDictionary.properties[key]
        : itemData;

      const info = isMob
        ? this.mobsDictionary.properties[key]
        : npcData;

      const position = this.map.indexToGridPosition(tileIndex);

      position.x += 1;

      if (!info || info === &apos;null&apos;) {
        if (this.debug) {
          log.info(
            `Unknown object spawned at: ${position.x} ${position.y}`,
          );
        }

        return;
      }

      const instance = Utils.generateInstance(
        isMob ? 2 : isNpc ? 3 : 4,
        info.id + entities,
        position.x + entities,
        position.y,
      );

      if (isMob) {
        const mob = new Mob(info.id, instance, position.x, position.y);

        mob.static = true;

        mob.onRespawn(() =&gt; {
          mob.dead = false;
          mob.refresh();
          this.addMob(mob);
        });

        this.addMob(mob);
      }

      if (isNpc) {
        this.addNPC(new NPC(info.id, instance, position.x, position.y));
      }

      if (isItem) {
        const item = this.createItem(info.id, instance, position.x, position.y);
        item.static = true;
        this.addItem(item);
      }

      entities += 1;
    });

    log.info(`Spawned ${entities} entities!`);
  }

  spawnChests() {
    let chests = 0;

    _.each(this.map.chests, (info) =&gt; {
      this.spawnChest(info.i, info.x, info.y, true);

      chests += 1;
    });

    log.info(`Spawned ${chests} static chests`);
  }

  spawnMob(id, x, y) {
    const instance = Utils.generateInstance(2, id, x + id, y);
    const mob = new Mob(id, instance, x, y);

    if (!MobsDictionary.exists(id)) {
      return null;
    }

    this.addMob(mob);
    return mob;
  }

  spawnChest(items, x, y, staticChest) {
    const chestCount = Object.keys(this.chests).length;
    const instance = Utils.generateInstance(5, 194, chestCount, x, y);
    const chest = new Chest(194, instance, x, y);

    chest.ItemsDictionary = items;

    if (staticChest) {
      chest.static = staticChest;
      chest.onRespawn(this.addChest.bind(this, chest));
    }

    /**
     * Pretty simple concept, detect when the player opens the chest
     * then remove it and drop an item instead. Give it a 25 second
     * cooldown prior to respawning and voila.
     */
    chest.onOpen(() =&gt; {
      this.removeChest(chest);
      this.dropItem(ItemsDictionary.stringToId(chest.getItem()), 1, chest.x, chest.y);
    });

    this.addChest(chest);
    return chest;
  }

  createItem(id, instance, x, y) {
    let item;

    if (ItemsDictionary.hasPlugin(id)) {
      item = new (ItemsDictionary.isNewPlugin(id))(id, instance, x, y);
    } else {
      item = new Item(id, instance, x, y);
    }

    return item;
  }

  dropItem(id, count, x, y) {
    const
      instance = Utils.generateInstance(
        4,
        id + Object.keys(this.entities).length,
        x,
        y,
      );

    const item = this.createItem(id, instance, x, y);

    item.count = count;
    item.dropped = true;

    this.addItem(item);
    item.despawn();

    item.onBlink(() =&gt; {
      this.pushBroadcast(new Messages.Blink(item.instance));
    });

    item.onDespawn(() =&gt; {
      this.removeItem(item);
    });
  }

  pushEntities(player) {
    let entities;

    if (!player || !(player.group in this.groups)) {
      return;
    }

    entities = _.keys(this.groups[player.group].entities);
    entities = _.reject(entities, instance =&gt; instance === player.instance);
    entities = _.map(entities, instance =&gt; parseInt(instance, 10));

    if (entities) {
      player.send(new Messages.List(entities));
    }
  }

  addEntity(entity) {
    if (entity.instance in this.entities) {
      log.info(`Entity ${entity.instance} already exists.`);
    }

    this.entities[entity.instance] = entity;

    if (entity.type !== &apos;projectile&apos;) {
      this.handleEntityGroup(entity);
    }

    if (entity.x &gt; 0 &amp;&amp; entity.y &gt; 0) {
      this.getGrids().addToEntityGrid(entity, entity.x, entity.y);
    }

    entity.onSetPosition(() =&gt; {
      this.getGrids().updateEntityPosition(entity);

      if (entity.isMob() &amp;&amp; entity.isOutsideSpawn()) {
        entity.removeTarget();
        entity.combat.forget();
        entity.combat.stop();

        entity.return();

        this.pushBroadcast(
          new Messages.Combat(
            Packets.CombatOpcode.Finish,
            null,
            entity.instance,
          ),
        );
        this.pushBroadcast(
          new Messages.Movement(Packets.MovementOpcode.Move, [
            entity.instance,
            entity.x,
            entity.y,
            false,
            false,
          ]),
        );
      }
    });

    if (entity instanceof Character) {
      entity.getCombat().setWorld(this);

      entity.onStunned((stun) =&gt; {
        this.pushToAdjacentGroups(
          entity.group,
          new Messages.Movement(Packets.MovementOpcode.Stunned, [
            entity.instance,
            stun,
          ]),
        );
      });
    }
  }

  addPlayer(player) {
    this.addEntity(player);
    this.players[player.instance] = player;

    if (this.populationCallback) this.populationCallback();
  }

  addToPackets(player) {
    this.packets[player.instance] = [];
  }

  addNPC(npc) {
    this.addEntity(npc);
    this.npcsDictionary[npc.instance] = npc;
  }

  addMob(mob) {
    if (!MobsDictionary.exists(mob.id)) {
      log.error(`Cannot spawn mob. ${mob.id} does not exist.`);
      return;
    }

    this.addEntity(mob);
    this.mobsDictionary[mob.instance] = mob;

    mob.addToChestArea(this.getChestAreas());

    mob.onHit((attacker) =&gt; {
      if (mob.isDead() || mob.combat.started) return;

      mob.combat.begin(attacker);
    });
  }

  addItem(item) {
    if (item.static) item.onRespawn(this.addItem.bind(this, item));

    this.addEntity(item);
    this.itemsDictionary[item.instance] = item;
  }

  addProjectile(projectile) {
    this.addEntity(projectile);
    this.projectiles[projectile.instance] = projectile;
  }

  addChest(chest) {
    this.addEntity(chest);
    this.chests[chest.instance] = chest;
  }

  removeEntity(entity) {
    if (entity.instance in this.entities) {
      delete this.entities[entity.instance];
    }

    if (entity.instance in this.mobsDictionary) {
      delete this.mobsDictionary[entity.instance];
    }

    if (entity.instance in this.itemsDictionary) {
      delete this.itemsDictionary[entity.instance];
    }

    this.getGrids().removeFromEntityGrid(entity, entity.x, entity.y);
    this.removeFromGroups(entity);
  }

  cleanCombat(entity) {
    entity.combat.stop();

    _.each(this.entities, (oEntity) =&gt; {
      if (oEntity instanceof Character &amp;&amp; oEntity.combat.hasAttacker(entity)) {
        oEntity.combat.removeAttacker(entity);
      }
    });
  }

  removeItem(item) {
    this.removeEntity(item);
    this.pushBroadcast(new Messages.Despawn(item.instance));

    if (item.static) item.respawn();
  }

  removePlayer(player) {
    this.pushToAdjacentGroups(
      player.group,
      new Messages.Despawn(player.instance),
    );

    if (player.ready) player.save();

    if (this.populationCallback) this.populationCallback();

    this.removeEntity(player);

    this.cleanCombat(player);

    if (player.isGuest) this.database.delete(player);

    delete this.players[player.instance];
    delete this.packets[player.instance];
  }

  removeProjectile(projectile) {
    this.removeEntity(projectile);

    delete this.projectiles[projectile.instance];
  }

  removeChest(chest) {
    this.removeEntity(chest);
    this.pushBroadcast(new Messages.Despawn(chest.instance));

    if (chest.static) chest.respawn();
    else delete this.chests[chest.instance];
  }

  playerInWorld(username) {
    for (const id in this.players) {
      if (this.players.hasOwnProperty(id) &amp;&amp; this.players[id].username === username) {
        return true;
      }
    }

    return false;
  }

  getPlayerByName(username) {
    for (const id in this.players) {
      if (this.players.hasOwnProperty(id)) {
        if (this.players[id].username.toLowerCase() === username.toLowerCase()) {
          return this.players[id];
        }
      }
    }

    return null;
  }

  saveAll() {
    _.each(this.players, (player) =&gt; {
      player.save();
    });
  }

  getPVPAreas() {
    return this.map.areas.PVP.pvpAreas;
  }

  getMusicAreas() {
    return this.map.areas.Music.musicAreas;
  }

  getChestAreas() {
    return this.map.areas.Chests.chestAreas;
  }

  getGrids() {
    return this.map.grids;
  }

  getPopulation() {
    return _.size(this.players);
  }

  onPlayerConnection(callback) {
    this.playerConnectCallback = callback;
  }

  onPopulationChange(callback) {
    this.populationCallback = callback;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
